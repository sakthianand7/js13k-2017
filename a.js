const a=(b)=>b[Math.floor(b.length*Math.random())],b=64,c=[.2,.5,.8,1],d=[2,3,4,5,6,7,8,10,12,14,16,18,22,26,30,36,40],e=[];for(let b=0;256>b;b+=50)for(let a=0;256>a;a+=50)for(let c=0;256>c;c+=50)e.push([b,a,c]);const f=new THREE.MeshPhongMaterial({color:16316664}),g=new THREE.MeshPhongMaterial({color:13158600}),i=new THREE.MeshBasicMaterial({color:8947848}),h=[b,b,d.length,e.length,c.length].map((b)=>Math.ceil(Math.log(b)/Math.LN2)),j=h.reduce((c,a)=>c+a,0),k=(f,c,g)=>{let b=0;for(let d=f;d<c;d++){const c=!!(g[Math.floor(d/8)]&1<<d%8);b+=+c<<d-f}return b},l=(b)=>({x:b[0],y:b[1],r:d[b[2]],color:e[b[3]],opacity:c[b[4]]}),m=(e)=>{const a=[];for(let f=0;f<=8*e.length-j;)a.push(l(h.map((a)=>{const b=f;return f+=a,k(b,f,e)})));return a},n=(b)=>fetch(b).then((b)=>b.arrayBuffer()).then((b)=>m(new Uint8Array(b))),o=(j,a,c)=>{var d=Math.round;let k,e,f;const g=(d,a,b)=>(0>b&&(b+=1),1<b&&(b-=1),b<1/6?d+6*(a-d)*b:b<1/2?a:b<2/3?d+6*((a-d)*(2/3-b)):d),b=.5>c?c*(1+a):c+a-c*a,h=2*c-b;return k=g(h,b,j+1/3),e=g(h,b,j),f=g(h,b,j-1/3),[d(255*k),d(255*e),d(255*f)]},q=Array.from({length:34},()=>{var d=Math.floor;const e=[Math.random(),Math.random()];return Array.from({length:30},(a,b)=>({r:d(30*Math.random())+10,x:d(64*Math.random()),y:d(64*Math.random()),color:o(e[+(15<b)],.5*Math.random(),.6*Math.random()+.2),opacity:Math.random()}))});let p=1;const r=[[['Oups, you are lost in a museum'],[],['Find your way out!'],[],['First stop:'],['Find "La Joconde"']],[['Good!'],[],['Next:'],['Find "Starry nigth"'],['by Van Gogh'],['in the room to your'],['left']],[['Nice!'],[],['Next stop:'],['"The creation '],['of Adam"'],['by Michelangelo'],['further in this room']],[['Great!'],[],['Find "Scream"'],['by Munch'],['in the room to your'],['right']],[['OK!'],[],['Next:'],['"The Great Wave"'],['by Hokusai'],['in this room']],[['Nice!'],[],['Next:'],['"La libert\xE9"'],['by Delacroix'],['in the next room']],[['Nice!'],[],['it\'s 12h30'],['no more time'],['let\'s say you win']]],s='                                                                        \n          ###########################                                   \n          #   ####  ####   ####    ############################         \n          #   #b##  #6##   #w##    #                          ##########\n    #######                        #                          #        #\n    #     #                            f      c      4        #####    #\n    #                                                                  #\n    #                                                                  #\n    #     #                            5      a      g        ##########\n    #     #                        #                          #         \n    #     #   #8##  ####   #9##    #                          #         \n    #     #   ####  ####   ####    ######################  ####         \n    #     ###############################################  #            \n    #                                 ###################  #            \n    ##############                    ##   #       #       #            \n                 #                    ##   r       h       3            \n                 #                    ##   #       #       #            \n                 #######################       #       #   #            \n                          ###########  #       #       d   #            \n                          #         #  #       #       #   ######       \n                          #         #  #       #       #        #       \n                          k         j  #       7       e   #### #       \n                          #         ####       #       #   #### #       \n                          #    1           2       #       #### #       \n                          #         ####   r       i       #### #       \n                          #         #  #   #       #       #### #       \n                          #         #  ################ ####### #       \n                          #         ###################         #       \n                          #### ##################################       \n                             #   #                                      \n                             #   #                                      \n                             #####                                      ',t=(b)=>{var a=Math.floor;return'1'===b?[null,1,null,null]:'2'===b?[null,null,2,null]:'3'===b?[null,null,3,null]:'4'===b?[4,null,null,null]:'5'===b?[5,null,null,null]:'6'===b?[null,6,null,null]:'7'===b?[null,null,7,null]:'8'===b?[null,null,null,8]:'9'===b?[null,null,null,9]:'a'===b?[10,null,null,null]:'b'===b?[null,11,null,null]:'c'===b?[12,null,null,null]:'d'===b?[null,null,13,null]:'e'===b?[null,null,14,null]:'f'===b?[15,null,null,null]:'g'===b?[16,null,null,null]:'h'===b?[null,null,17,null]:'i'===b?[null,null,18,null]:'j'===b?[null,null,19,null]:'k'===b?[20,null,null,null]:'l'===b?[null,null,a(10*Math.random())+21,null]:'t'===b?[null,null,null,a(10*Math.random())+21]:'r'===b?[a(10*Math.random())+21,null,null,null]:'w'===b?[null,a(10*Math.random())+21,null,null]:[null,null,null,null]},u={worldGrid:s.split('\n').map((b)=>b.split('').map((b)=>' '===b?0:t(b))),tim:{position:{x:30.5,y:31.5},direction:{x:0,y:1}},control:{direction:{x:0,y:0}}},w=[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0},{x:1,y:1},{x:-1,y:1},{x:-1,y:-1},{x:1,y:-1}],v=(d,a,b)=>0<=a&&a<d.length&&0<=b&&b<d[0].length,z=(d,a,b)=>!v(d,a,b)||!!d[a][b],x=(j,a)=>{var b=Math.floor;const i=b(j.x),c=b(j.y);return w.reduce((d,k)=>{const l=i+k.x,m=c+k.y;if(z(a,l,m)){const a=0===k.x?0:0<k.x?1-j.x%1:j.x%1,b=0===k.y?0:0<k.y?1-j.y%1:j.y%1,c=Math.sqrt(a*a+b*b);return!d||d.d>c?{x:l,y:m,dir:k,d:c}:d}return d},null)},y=()=>{const{position:d,direction:a}=u.tim,b=u.control;d.x+=(a.x*b.direction.y+a.y*b.direction.x)*.05,d.y+=.05*(a.y*b.direction.y-a.x*b.direction.x);const c=x(d,u.worldGrid),e=.2;if(c&&c.d<e){const a=e-c.d;d.x-=a*c.dir.x,d.y-=a*c.dir.y}},A=[0,0,0,0],B=(d)=>(a)=>{A[{38:0,32:0,87:0,40:2,83:2,37:1,65:1,39:3,68:3}[a.which]]=d;const b=(A[0]|A[2])&(A[1]|A[3])?Math.SQRT1_2:1;u.control.direction.y=(A[0]-A[2])*b,u.control.direction.x=(A[1]-A[3])*b};document.onkeydown=B(1),document.onkeyup=B(0),document.ontouchstart=()=>u.control.direction.y=1,document.ontouchend=()=>u.control.direction.y=0,AFRAME.registerComponent('tim',{init:function(){{const d=new THREE.BoxGeometry(.1,.1,.1),a=new THREE.MeshLambertMaterial({color:2200494}),b=new THREE.Mesh(d,a);this.el.object3D.add(b)}},tick:function(){const b=this.el.children[0].object3D.rotation.y;u.tim.direction.x=-Math.sin(b),u.tim.direction.y=-Math.cos(b),y(),this.el.object3D.position.set(u.tim.position.x,.6,u.tim.position.y)}});const C=.28,D=100,E=new THREE.PlaneBufferGeometry(1,1),F=(d,a,b)=>Math.max(0,Math.min(1,(b-(1-C)*(d-a)/d)/C)),G=(i,a,b,d)=>{const e=(36*i+137*(a*a*i)+89*(i*i))%37/37,f=Math.sin(.045*(1+e)*d)*b,g=Math.cos(.035*(1+e)*d)*b,h=i-.5+(.5>i?-.4:.4);return{x:i+h*b+.2*f,y:a+(a-.5)*b+.17*g,z:b*(.6+.6*e+.23*f*(1+e)),s:.3+.7*(1-b)}},H=(i,m,b,a,c,e)=>{const f=512;i.width=i.height=f;const g=i.getContext('2d');g.beginPath(),g.rect(0,0,f,f),g.fillStyle='#fff',g.fill(),b.forEach((h,a)=>{const j=F(b.length,a,c),i=G(h.x/m,h.y/m,j,e),k=h.r*i.s/m,d=i.z>k?0:Math.sqrt(k*k-i.z*i.z);g.beginPath(),g.arc(i.x*f,i.y*f,d*f,0,2*Math.PI),g.fillStyle='rgb('+h.color+')',g.globalAlpha=h.opacity,g.fill()}),.8<c&&a&&(g.globalAlpha=(c-.8)/.2,a.forEach((c,a)=>{g.fillStyle='#333',g.font='50px Helvetica',g.fillText(c,50,60*a+100)}))},I=(k)=>{var h=Math.ceil;const n=64,o=new THREE.Object3D,b=q[k],a=r[k],d=document.createElement('canvas'),s=d.getContext('2d');s.fillStyle='#fff',s.fillRect(0,0,n,n),b.forEach(({r:b,opacity:i,color:d,x:m,y:f})=>{const e=new THREE.MeshLambertMaterial;{s.beginPath(),s.arc(m,f,b,0,2*Math.PI),s.fillStyle='rgb('+d+')',s.globalAlpha=i,s.fill();const{data:g}=s.getImageData(0,0,n,n),h=[0,0,0];let j=0;for(let c=-b;c<b;c++)for(let d=-b;d<b;d++)if(c*c+d*d<b*b&&0<=m+c&&0<=f+d&&m+c<n&&f+d<n){const b=4*(1*(m+c)+(f+d)*n);h[0]+=g[b+0],h[1]+=g[b+1],h[2]+=g[b+2],j++}e.color.setRGB(h[0]/j/255,h[1]/j/255,h[2]/j/255)}const c=new THREE.SphereBufferGeometry(Math.min(b/n,.5),h(b/4)+4,h(b/4)+4),g=new THREE.Mesh(c,e);o.add(g)});const e=new THREE.Texture(d);{e.needsUpdate=!0,e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(1,1);const c=new THREE.MeshBasicMaterial;c.map=e;const a=new THREE.Mesh(E,c);a.position.z=.02,o.add(a);const b=new THREE.Mesh(E,g);b.position.z=.01,b.scale.set(1.1,1.1,1.1),o.add(b)}let f=-1;const i=(c,g)=>{k>p&&(c=0),k==p&&.9<c&&p++,(0<c||.1<Math.abs(c-f)||0<f&&0==c)&&(H(d,n,b,a,f=c,g),e.needsUpdate=!0,b.forEach((d,a)=>{const e=F(b.length,a,c),f=G(d.x/n,d.y/n,e,g);o.children[a].visible=0<e,o.children[a].scale.set(f.s,f.s,f.s*e),o.children[a].position.set(f.x-.5,-(f.y-.5),f.z-.1)}))};return i(0,0),{object:o,update:i,t:0}},J=(j)=>{var f=Math.max;const k=[],b=new THREE.Object3D;for(let c=0;c<j.length;c++)for(let d=0;d<j[0].length;d++)for(let e=0;j[c][d]&&4>e;e++)if(j[c][d][e]){const f=I(j[c][d][e]);k.push(f);const g=w[e],h=.6+.35*Math.random();f.object.scale.set(h,h,h),f.object.position.set(c+.5+.505*g.x,1,d+.5+.505*g.y),f.object.rotation.y=Math.PI/2*e,b.add(f.object)}let l=0;return{object:b,update:({position:a,direction:b})=>{l+=1,k.forEach((e)=>{const c=a.x-e.object.position.x,g=a.y-e.object.position.z,h=Math.sqrt(c*c+g*g),i=f(0,-(c*b.x+g*b.y)/h);e.t=3>h&&.92<i?Math.min(D+50,e.t+1):f(.98*(e.t+1)-2,0),e.update(f(0,(e.t-50)/D),l)})}}},K=(l)=>{var g=Math.PI,h=Math.max,j=Math.min;const m=new THREE.Object3D,b=l.length,k=l[0].length,n=new THREE.MeshLambertMaterial;{const e=document.createElement('canvas'),f=256;e.height=1,e.width=f;const b=e.getContext('2d');for(let c=f;c--;)b.fillStyle=.06<c/f?'#fff':'#888',b.fillRect(c,0,1,1);const a=new THREE.Texture(e,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);a.needsUpdate=!0,n.map=a}{const e=document.createElement('canvas'),i=128;e.width=e.height=i;const b=e.getContext('2d');b.fillStyle='#fff',b.fillRect(0,0,i,i);for(let c=i;c--;)for(let a=i;a--;){const d=Math.sqrt(c*c+a*a)/128/1.45,e=j(1,h(0,3*(1-a/i))),f=j(1,h(0,3*(a/i)));b.fillStyle=`hsl(0, 0%, ${100*((.4+.6*(1-(1-e)*(1-e)))*(1-d*d)*(.88+.12*f))}%)`,b.fillRect(c,a,1,1)}const a=new THREE.Texture(e,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.NearestFilter,THREE.LinearFilter);a.needsUpdate=!0,n.aoMap=a,n.aoMapIntensity=.8}const o=new THREE.MeshLambertMaterial;{const d=document.createElement('canvas');d.width=512,d.height=1;const e=d.getContext('2d');for(let b=16;b--;){e.beginPath(),e.rect(32*b,0,32,1);const a=32+(0|8*Math.random()),c=22+(0|20*Math.random());e.fillStyle=`hsl(${a}, 55%, ${c}%)`,e.fill()}const a=new THREE.Texture(d,THREE.UVMapping,THREE.RepeatWrapping,THREE.LinearFilter,THREE.LinearFilter);a.needsUpdate=!0,a.repeat.set(10,1),o.map=a}{const a=1024,b=document.createElement('canvas');b.width=b.height=a;const j=b.getContext('2d'),d=l.length,e=l[0].length;j.fillStyle='#fff',j.fillRect(0,0,a,a),j.fillStyle='#333',j.filter=`blur(${.12*a/d}px)`;const g=1.12;for(let b=l.length;b--;)for(let c=l[0].length;c--;)l[b][c]&&j.fillRect((b-(g-1)/2)/d*a,(c-(g-1)/2)/e*a,g*a/d,g*a/e);const c=new THREE.Texture(b,THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.LinearFilter,THREE.LinearFilter);c.needsUpdate=!0,o.aoMap=c,o.aoMapIntensity=1.4}{const c=new THREE.PlaneGeometry(b,k);c.faceVertexUvs[1]=c.faceVertexUvs[0];const a=new THREE.Mesh(c,o);a.position.set(b/2,0,k/2),a.rotation.x=-g/2,a.receiveShadow=!0,m.add(a)}{const o=new THREE.Geometry;o.faceVertexUvs=[[],[]];const c=new THREE.Vector2(0,0),f=new THREE.Vector2(1,0),g=o.faceVertexUvs[0],h=o.faceVertexUvs[1],r=(i,e,a,b,j)=>{const k=o.faces.length;g[k]=[c,f,f],g[k+1]=[c,f,c],h[k]=[new THREE.Vector2(0,.05),new THREE.Vector2(0,.95),new THREE.Vector2(0,.95)],h[k+1]=[new THREE.Vector2(0,.05),new THREE.Vector2(0,.95),new THREE.Vector2(0,.05)];const d=1-.8*j;b?(h[k][0].x=1,h[k][1].x=1,h[k][2].x=d,h[k+1][0].x=1,h[k+1][1].x=d,h[k+1][2].x=d):a&&(h[k][0].x=d,h[k][1].x=d,h[k][2].x=1,h[k+1][0].x=d,h[k+1][1].x=1,h[k+1][2].x=1),o.faces.push(new THREE.Face3(o.vertices.length+0,o.vertices.length+1,o.vertices.length+2),new THREE.Face3(o.vertices.length+0,o.vertices.length+2,o.vertices.length+3)),o.vertices.push(new THREE.Vector3(e.x,0,e.y),new THREE.Vector3(e.x,1,e.y),new THREE.Vector3(i.x,1,i.y),new THREE.Vector3(i.x,0,i.y))},a=[[],[],[],[]];for(let d=l.length;d--;)for(let b=l[0].length;b--;)if(l[d][b])for(let c=0;4>c;c++)z(l,d+w[c].x,b+w[c].y)||a[c].push({x:d+w[c].x,y:b+w[c].y});for(let k=0;4>k;k++){const c=a[k],e=w[k].y?'y':'x',f='y'===e?'x':'y',d=w[k].y+w[k].x;for(;c.length;){const a=c.shift();let g=a[f],h=g;const i=a[e];for(let a=-1;a!=c.length;){a=c.length;for(let b=c.length;b--;)c[b][e]===i&&(c[b][f]===g-1?(c.splice(b,1),--g):c[b][f]===h+1&&(c.splice(b,1),--h))}const b={},j={};b[e]=j[e]=i+(0==k||1===k?0:1),b[f]=g,j[f]=h+1;const m=h+1-g;let n=!1,d=!1;0===k?(n=z(l,b.x-1,b.y),d=z(l,j.x,j.y)):1===k?(n=z(l,b.x,b.y-1),d=z(l,j.x,j.y)):2===k?(n=z(l,b.x-1,b.y-1),d=z(l,j.x,j.y-1)):3===k&&(n=z(l,b.x-1,b.y-1),d=z(l,j.x-1,j.y));const o=0==k||3===k?r:(e,f,a,b,c)=>r(f,e,b,a,c);if(n&&d){const c={x:(b.x+j.x)/2,y:(b.y+j.y)/2};o(b,c,!0,!1,m/2),o(c,j,!1,!0,m/2)}else o(b,j,n,d,m)}}o.computeFlatVertexNormals(),o.computeFaceNormals(),o.verticesNeedUpdate=!0,o.normalsNeedUpdate=!0,o.uvsNeedUpdate=!0;const b=new THREE.Mesh(o,n);b.scale.set(1,2.8,1),m.add(b)}{const b=new THREE.PlaneBufferGeometry(.06,k);for(let c=0;c<l.length;c+=3){const d=new THREE.Mesh(b,i);d.rotation.x=g/2,d.position.set(c+.03,4.5,k/2),m.add(d)}}{const b=document.createElement('canvas');b.height=b.width=512;const e=b.getContext('2d');e.fillStyle='#fff',e.fillRect(0,0,512,512),r[0].forEach((c,a)=>{e.fillStyle='#333',e.font='30px Helvetica',e.fillText(c,50,40*a+100)});const a=new THREE.Texture(b);a.needsUpdate=!0,a.wrapS=a.wrapT=THREE.RepeatWrapping,a.repeat.set(1,1);const c=new THREE.MeshLambertMaterial;c.map=a,c.aoMap=n.aoMap,c.aoMapIntensity=n.aoMapIntensity;const d=new THREE.PlaneGeometry(2,2),f=1-.8*2,g=.12,h=.7;d.faceVertexUvs[1]=[[new THREE.Vector2(f,h),new THREE.Vector2(f,g),new THREE.Vector2(1,h)],[new THREE.Vector2(f,g),new THREE.Vector2(1,g),new THREE.Vector2(1,h)]],d.uvsNeedUpdate;const i=new THREE.Mesh(d,c);i.position.z=.005;const j=new THREE.Object3D;j.position.set(30,1.2,30),j.rotation.y=0,j.add(i),m.add(j)}return m};AFRAME.registerComponent('museum',{init:function(){const b=this.el.object3D;b.add(K(u.worldGrid)),Promise.all(['1','2','6','3','4','5','7','8','9','a','b','c','d','e','f','g','h','i','j','k'].map((c,d)=>n(c).then((b)=>q[d+1]=b))).then(()=>{this.p=J(u.worldGrid),b.add(this.p.object)})},tick:function(){this.p&&this.p.update(u.tim)}}),window.onload=()=>{const{renderer:b}=document.getElementsByTagName('a-scene')[0];document.getElementById('m').onclick=()=>navigator.getUserMedia({audio:1},(d)=>{const a=new AudioContext,b=a.createScriptProcessor(4096,1,1);a.createMediaStreamSource(d).connect(b),b.connect(a.destination),b.onaudioprocess=(c)=>{const a=Math.max(...c.inputBuffer.getChannelData(0));u.control.direction.y=.16<a?1:0}},(b)=>b)};
